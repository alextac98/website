---
import ImageMod from "./ImageMod.astro";

interface CategoryItem {
  title: string;
  image: string;
  link: string;
  /** Grid column span (for flexible layouts). Defaults to 1 */
  colSpan?: number;
  /** Grid row span (for flexible layouts). Defaults to 1 */
  rowSpan?: number;
}

interface Props {
  categories: CategoryItem[];
  /** Number of columns in the grid. Defaults to 12 (allows 1/2, 1/3, 1/4, 1/6, 1/12 divisions) */
  columns?: number;
  /** Number of rows in the grid. Defaults to 2 */
  rows?: number;
  /** Base row height in pixels. Defaults to 100 */
  rowHeight?: number;
  /** Animation duration in seconds. Defaults to 0.
   *
  2 */
  animationDuration?: number;
}

const {
  categories,
  columns = 12,
  rows = 2,
  rowHeight = 100,
  animationDuration = 0.3,
} = Astro.props;
---

<div
  class="category-mosaic"
  style={`--mosaic-columns: ${columns}; --mosaic-rows: ${rows}; --row-height: ${rowHeight}px; --animation-duration: ${animationDuration}s`}
>
  {
    categories.map((category, index) => (
      <a
        href={category.link}
        class="mosaic-item"
        style={`--col-span: ${category.colSpan || 1}; --row-span: ${category.rowSpan || 1}`}
        data-mosaic-item
      >
        <div class="mosaic-image-wrapper">
          <ImageMod
            src={category.image}
            alt={category.title}
            width={600}
            height={400}
            class="mosaic-image"
            format="webp"
          />
        </div>
        <div class="mosaic-overlay" data-overlay>
          <span class="mosaic-title">{category.title}</span>
        </div>
      </a>
    ))
  }
</div>

<style>
  .category-mosaic {
    display: grid;
    grid-template-columns: repeat(var(--mosaic-columns), 1fr);
    grid-template-rows: repeat(var(--mosaic-rows), var(--row-height));
    grid-auto-rows: var(--row-height);
    gap: 1rem;
    padding: 1rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .mosaic-item {
    position: relative;
    overflow: hidden;
    border-radius: 0.5rem;
    grid-column: span var(--col-span);
    grid-row: span var(--row-span);
    cursor: pointer;
    text-decoration: none;
  }

  .mosaic-image-wrapper {
    width: 100%;
    height: 100%;
    transition: filter var(--animation-duration) ease;
  }

  .mosaic-image-wrapper :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .mosaic-item:hover .mosaic-image-wrapper,
  .mosaic-item.is-hovered .mosaic-image-wrapper {
    filter: grayscale(100%) brightness(0.5);
  }

  .mosaic-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.5);
    opacity: 0;
    pointer-events: none;
  }

  .mosaic-title {
    color: white;
    font-size: 1.5rem;
    font-weight: 600;
    text-align: center;
    padding: 1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  /* Directional slide animations */
  .mosaic-overlay.slide-from-top {
    animation: slideFromTop var(--animation-duration) ease forwards;
  }
  .mosaic-overlay.slide-from-bottom {
    animation: slideFromBottom var(--animation-duration) ease forwards;
  }
  .mosaic-overlay.slide-from-left {
    animation: slideFromLeft var(--animation-duration) ease forwards;
  }
  .mosaic-overlay.slide-from-right {
    animation: slideFromRight var(--animation-duration) ease forwards;
  }

  .mosaic-overlay.slide-to-top {
    animation: slideToTop var(--animation-duration) ease forwards;
  }
  .mosaic-overlay.slide-to-bottom {
    animation: slideToBottom var(--animation-duration) ease forwards;
  }
  .mosaic-overlay.slide-to-left {
    animation: slideToLeft var(--animation-duration) ease forwards;
  }
  .mosaic-overlay.slide-to-right {
    animation: slideToRight var(--animation-duration) ease forwards;
  }

  @keyframes slideFromTop {
    from {
      transform: translateY(-100%);
      opacity: 1;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  @keyframes slideFromBottom {
    from {
      transform: translateY(100%);
      opacity: 1;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  @keyframes slideFromLeft {
    from {
      transform: translateX(-100%);
      opacity: 1;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  @keyframes slideFromRight {
    from {
      transform: translateX(100%);
      opacity: 1;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideToTop {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(-100%);
      opacity: 0;
    }
  }
  @keyframes slideToBottom {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(100%);
      opacity: 0;
    }
  }
  @keyframes slideToLeft {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(-100%);
      opacity: 0;
    }
  }
  @keyframes slideToRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  /* Responsive adjustments */
  @media (max-width: 1024px) {
    .category-mosaic {
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: auto;
      grid-auto-rows: minmax(150px, auto);
    }
    .mosaic-item {
      grid-column: span 1 !important;
      grid-row: span 1 !important;
      aspect-ratio: 1 / 1;
    }
  }

  @media (max-width: 640px) {
    .category-mosaic {
      grid-template-columns: 1fr;
      grid-template-rows: auto;
      gap: 0.75rem;
      padding: 0.75rem;
    }
    .mosaic-item {
      grid-row: span 1 !important;
      aspect-ratio: 16 / 9;
      min-height: 200px;
    }
    .mosaic-title {
      font-size: 1.25rem;
    }
  }
</style>

<script>
  function getDirection(
    element: HTMLElement,
    event: MouseEvent,
  ): "top" | "bottom" | "left" | "right" {
    const rect = element.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    const width = rect.width;
    const height = rect.height;

    // Calculate relative position (0 to 1)
    const relX = x / width;
    const relY = y / height;

    // Calculate distance from each edge
    const distTop = relY;
    const distBottom = 1 - relY;
    const distLeft = relX;
    const distRight = 1 - relX;

    // Find minimum distance to determine entry edge
    const min = Math.min(distTop, distBottom, distLeft, distRight);

    if (min === distTop) return "top";
    if (min === distBottom) return "bottom";
    if (min === distLeft) return "left";
    return "right";
  }

  function clearAnimationClasses(overlay: HTMLElement) {
    overlay.classList.remove(
      "slide-from-top",
      "slide-from-bottom",
      "slide-from-left",
      "slide-from-right",
      "slide-to-top",
      "slide-to-bottom",
      "slide-to-left",
      "slide-to-right",
    );
  }

  function initMosaicItems() {
    const items = document.querySelectorAll("[data-mosaic-item]");

    items.forEach((item) => {
      const element = item as HTMLElement;
      const overlay = element.querySelector("[data-overlay]") as HTMLElement;
      if (!overlay) return;

      let lastDirection: "top" | "bottom" | "left" | "right" = "top";

      element.addEventListener("mouseenter", (event: MouseEvent) => {
        const direction = getDirection(element, event);
        lastDirection = direction;

        clearAnimationClasses(overlay);
        element.classList.add("is-hovered");
        overlay.classList.add(`slide-from-${direction}`);
      });

      element.addEventListener("mouseleave", (event: MouseEvent) => {
        const direction = getDirection(element, event);

        clearAnimationClasses(overlay);
        element.classList.remove("is-hovered");
        overlay.classList.add(`slide-to-${direction}`);
      });
    });
  }

  // Initialize on page load
  initMosaicItems();

  // Re-initialize after Astro page transitions (if using View Transitions)
  document.addEventListener("astro:page-load", initMosaicItems);
</script>
