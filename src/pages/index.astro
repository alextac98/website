---
import ImageMod from "@/components/ImageMod.astro";
import CategoryMosaic from "@/components/CategoryMosaic.astro";
import ProjectCard from "@/components/ProjectCard.astro";
import BlogCard from "@/components/BlogCard.astro";
import Base from "@/layouts/Base.astro";
import { getListPage, getSinglePage } from "@/lib/contentParser.astro";
import { markdownify } from "@/lib/utils/textConverter";
import CallToAction from "@/partials/CallToAction.astro";
import { sortByDate } from "@/lib/utils/sortFunctions";

const homepage = await getListPage("homepage", "-index");
const call_to_action = await getListPage("ctaSection", "call-to-action");

// Fetch projects and blog posts
const allProjects = await getSinglePage("projects");
const allBlogPosts = await getSinglePage("blog");

// Get featured projects (prioritize featured, then sort by date)
const featuredProjects = sortByDate(
  allProjects.filter((p) => p.data.featured),
).slice(0, homepage.data.featured_projects?.count || 3);

// If not enough featured projects, fill with recent ones
const recentProjects =
  featuredProjects.length < (homepage.data.featured_projects?.count || 3)
    ? sortByDate(allProjects.filter((p) => !p.data.featured)).slice(
        0,
        (homepage.data.featured_projects?.count || 3) - featuredProjects.length,
      )
    : [];

const displayProjects = [...featuredProjects, ...recentProjects];

// Get recent blog posts sorted by date
const recentPosts = sortByDate(allBlogPosts).slice(
  0,
  homepage.data.recent_posts?.count || 3,
);

const { mosaic, aboutme, featured_projects, recent_posts } = homepage.data;
---

<Base>
  <!-- Category Mosaic -->
  <section class="pt-8">
    <div class="container">
      <CategoryMosaic
        categories={mosaic.categories}
        columns={mosaic.columns}
        rows={mosaic.rows}
        rowHeight={mosaic.rowHeight}
        animationDuration={mosaic.animationDuration}
      />
    </div>
  </section>
  <!-- /Category Mosaic -->

  <!-- About Me -->
  <section class="section-sm bg-gradient">
    <div class="container">
      <div class="row items-stretch justify-between">
        <!-- Left Column: Image (spans full height) -->
        <div class="mb-8 md:mb-0 md:col-4">
          {
            aboutme.image && (
              <ImageMod
                src={aboutme.image}
                height={600}
                width={400}
                alt="Alex Tacescu"
                format="webp"
                class="rounded-lg w-full h-full object-cover"
              />
            )
          }
        </div>

        <!-- Right Column: Stacked content -->
        <div class="md:col-8">
          <!-- Top: Title + Short Text -->
          <div class="mb-6">
            <h2 set:html={markdownify(aboutme.title)} class="mb-4" />
            <p set:html={markdownify(aboutme.short)} />
          </div>

          <!-- Bottom: Long Text + Video side by side -->
          <div class="row items-start">
            <!-- Long Text -->
            <div class="mb-6 md:mb-0 md:col-6">
              <p set:html={markdownify(aboutme.long)} />
              {
                aboutme.button.enable && (
                  <div class="flex justify-center mt-4">
                    <a
                      class="btn btn-primary"
                      href={aboutme.button.link}
                      target={
                        aboutme.button.link.startsWith("http")
                          ? "_blank"
                          : "_self"
                      }
                      rel="noopener"
                    >
                      {aboutme.button.label}
                    </a>
                  </div>
                )
              }
            </div>

            <!-- Video -->
            {
              aboutme.video?.enable && (
                <div class="md:col-6">
                  <h4 class="mb-4">
                    <a href={aboutme.video.fallback_url}>
                      {aboutme.video.title}
                    </a>
                  </h4>
                  <video
                    controls
                    class="w-full rounded-lg shadow-lg object-cover"
                    poster={aboutme.video.thumbnail}
                    preload="metadata"
                  >
                    <source src={aboutme.video.url} type="video/mp4" />
                    <p>
                      Your browser doesn't support HTML5 video.{" "}
                      <a
                        href={aboutme.video.fallback_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-primary hover:underline"
                      >
                        Watch it on NBC.com instead.
                      </a>
                    </p>
                  </video>
                </div>
              )
            }
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- /About Me -->

  <!-- Featured Projects -->
  {
    featured_projects?.enable && (
      <section class="section-sm bg-gradient">
        <div class="container">
          <div class="mb-12 text-center">
            <h2 class="mb-4">{featured_projects.title}</h2>
            <p class="text-lg">{featured_projects.description}</p>
          </div>
          <div class="row">
            {displayProjects.map((project) => (
              <div class="mb-8 md:col-6 lg:col-4">
                <ProjectCard data={project} basePath="projects" />
              </div>
            ))}
          </div>
          {featured_projects.button?.enable && (
            <div class="mt-8 text-center">
              <a class="btn btn-primary" href={featured_projects.button.link}>
                {featured_projects.button.label}
              </a>
            </div>
          )}
        </div>
      </section>
    )
  }
  <!-- /Featured Projects -->

  <!-- Recent Blog Posts -->
  {
    recent_posts?.enable && (
      <section class="section-sm">
        <div class="container">
          <div class="mb-12 text-center">
            <h2 class="mb-4">{recent_posts.title}</h2>
            <p class="text-lg">{recent_posts.description}</p>
          </div>
          <div class="row">
            {recentPosts.map((post) => (
              <div class="mb-8 md:col-6 lg:col-4">
                <BlogCard data={post} />
              </div>
            ))}
          </div>
          {recent_posts.button?.enable && (
            <div class="mt-8 text-center">
              <a class="btn btn-primary" href={recent_posts.button.link}>
                {recent_posts.button.label}
              </a>
            </div>
          )}
        </div>
      </section>
    )
  }
  <!-- /Recent Blog Posts -->

  <CallToAction call_to_action={call_to_action} />
</Base>
